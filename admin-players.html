<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Stats Import</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        
        h2 {
            color: #555;
            margin-top: 30px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        .import-section {
            margin-bottom: 40px;
        }
        
        .import-controls {
            display: flex;
            gap: 20px;
            align-items: flex-end;
            flex-wrap: wrap;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        label {
            font-weight: 600;
            color: #666;
            font-size: 14px;
        }
        
        input[type="number"], 
        input[type="text"],
        select {
            padding: 10px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            width: 180px;
            transition: border-color 0.3s;
        }
        
        input[type="number"]:focus,
        input[type="text"]:focus,
        select:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        button {
            padding: 12px 24px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .warning-button {
            background-color: #ff9800;
        }
        
        .warning-button:hover {
            background-color: #f57c00;
        }
        
        #status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            display: none;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        #results {
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
            display: none;
        }
        
        .result-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .progress-container {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
        
        .progress-bar {
            width: 0%;
            height: 25px;
            background-color: #4CAF50;
            border-radius: 8px;
            text-align: center;
            line-height: 25px;
            color: white;
            font-weight: bold;
            transition: width 0.3s ease;
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 15% auto;
            padding: 30px;
            border-radius: 12px;
            width: 80%;
            max-width: 500px;
            text-align: center;
        }
        
        .modal h3 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 30px;
        }
        
        .cancel-button {
            background-color: #6c757d;
        }
        
        .cancel-button:hover {
            background-color: #5a6268;
        }
        
        .warning-text {
            color: #ff9800;
            font-weight: 600;
            margin: 15px 0;
        }

        .batch-info {
            background-color: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-size: 14px;
            color: #1565c0;
        }
        
        .progress-details {
            background-color: #f8f9fa;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            font-family: monospace;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Admin - Season Stats Import</h1>
        
        <!-- Season Stats Import Section -->
        <div class="import-section">
            <h2>Import Season Stats</h2>
            <div class="import-controls">
                <div class="input-group">
                    <label for="seasonYear">Season Year:</label>
                    <select id="seasonYear">
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="weekSelect">Week:</label>
                    <select id="weekSelect">
                        <option value="all">All Weeks (1-18)</option>
                        <option value="totals">Season Totals Only</option>
                        <optgroup label="Individual Weeks">
                            <option value="1">Week 1</option>
                            <option value="2">Week 2</option>
                            <option value="3">Week 3</option>
                            <option value="4">Week 4</option>
                            <option value="5">Week 5</option>
                            <option value="6">Week 6</option>
                            <option value="7">Week 7</option>
                            <option value="8">Week 8</option>
                            <option value="9">Week 9</option>
                            <option value="10">Week 10</option>
                            <option value="11">Week 11</option>
                            <option value="12">Week 12</option>
                            <option value="13">Week 13</option>
                            <option value="14">Week 14</option>
                            <option value="15">Week 15</option>
                            <option value="16">Week 16</option>
                            <option value="17">Week 17</option>
                            <option value="18">Week 18</option>
                        </optgroup>
                    </select>
                </div>
                <div class="input-group">
                    <label for="maxPlayers">Max Players:</label>
                    <input type="number" id="maxPlayers" min="10" max="1000" value="450" placeholder="e.g., 450">
                </div>
                <div class="input-group">
                    <label for="batchSize">Batch Size:</label>
                    <input type="number" id="batchSize" min="5" max="25" value="10" placeholder="e.g., 10">
                </div>
                <button id="importStatsBtn" class="warning-button" onclick="showStatsConfirmation()">Import Stats</button>
            </div>
            
            <div class="batch-info">
                <strong>Import Options:</strong><br>
                ‚Ä¢ <strong>All Weeks:</strong> Import complete season (all 18 weeks + totals)<br>
                ‚Ä¢ <strong>Season Totals Only:</strong> Import just the season total statistics<br>
                ‚Ä¢ <strong>Individual Week:</strong> Import data for a specific week only<br>
                <br>
                <strong>Batch Size Guidelines:</strong><br>
                ‚Ä¢ 5-10: Safe for CPU limits, slower overall<br>
                ‚Ä¢ 10-15: Balanced performance and safety<br>
                ‚Ä¢ 15-25: Faster but may hit CPU limits<br>
                <em>Recommended: 10 for reliable imports</em>
            </div>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>
        
        <div class="progress-details" id="progressDetails" style="display: none;">
            <div><strong>Current Operation:</strong> <span id="currentOperation">Initializing...</span></div>
            <div><strong>Batch Progress:</strong> <span id="batchProgress">0/0</span></div>
            <div><strong>Week Progress:</strong> <span id="weekProgress">0/18</span></div>
            <div><strong>Total Players:</strong> <span id="totalPlayersCount">0</span></div>
        </div>
        
        <div id="status"></div>
        <div id="results"></div>
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal">
        <div class="modal-content">
            <h3>Import Statistics</h3>
            <p>You are about to import statistics for the <strong id="modalYear"></strong> season.</p>
            <p><strong>Import Type:</strong> <span id="modalImportType"></span></p>
            <p>Max Players: <strong id="modalMaxPlayers"></strong></p>
            <p>Batch Size: <strong id="modalBatchSize"></strong></p>
            <p class="warning-text" id="modalWarning">‚ö†Ô∏è This operation may take several minutes.</p>
            <p>Do you want to continue?</p>
            <div class="modal-buttons">
                <button class="cancel-button" onclick="closeModal()">Cancel</button>
                <button onclick="confirmStatsImport()">Continue</button>
            </div>
        </div>
    </div>

<script>
// Global state for import
let importState = {
    isImporting: false,
    year: null,
    weekSelection: null,
    maxPlayers: null,
    batchSize: null,
    currentBatch: 0,
    totalBatches: 0,
    totalPlayersProcessed: 0,
    startTime: null
};

// Show confirmation modal
function showStatsConfirmation() {
    console.log('showStatsConfirmation called');
    
    const year = document.getElementById('seasonYear').value;
    const weekSelection = document.getElementById('weekSelect').value;
    const maxPlayers = document.getElementById('maxPlayers').value;
    const batchSize = document.getElementById('batchSize').value;
    
    console.log('Form values:', { year, weekSelection, maxPlayers, batchSize });
    
    document.getElementById('modalYear').textContent = year;
    document.getElementById('modalMaxPlayers').textContent = maxPlayers;
    document.getElementById('modalBatchSize').textContent = batchSize;
    
    // Set import type description
    let importTypeText = '';
    let warningText = '';
    
    if (weekSelection === 'all') {
        importTypeText = 'All 18 weeks + season totals';
        warningText = '‚ö†Ô∏è This will import the complete season and may take 15-30 minutes.';
    } else if (weekSelection === 'totals') {
        importTypeText = 'Season totals only';
        warningText = '‚ö†Ô∏è This will import season total statistics only.';
    } else {
        importTypeText = `Week ${weekSelection} only`;
        warningText = `‚ö†Ô∏è This will import data for Week ${weekSelection} only.`;
    }
    
    document.getElementById('modalImportType').textContent = importTypeText;
    document.getElementById('modalWarning').textContent = warningText;
    document.getElementById('confirmModal').style.display = 'block';
    
    console.log('Modal should be visible now');
}

// Close modal
function closeModal() {
    document.getElementById('confirmModal').style.display = 'none';
}

// Confirm and start import
async function confirmStatsImport() {
    console.log('confirmStatsImport called');
    closeModal();
    
    const year = parseInt(document.getElementById('seasonYear').value);
    const weekSelection = document.getElementById('weekSelect').value;
    const maxPlayers = parseInt(document.getElementById('maxPlayers').value);
    const batchSize = parseInt(document.getElementById('batchSize').value);
    
    console.log('Starting import with:', { year, weekSelection, maxPlayers, batchSize });
    
    // Initialize import state
    importState = {
        isImporting: true,
        year: year,
        weekSelection: weekSelection,
        maxPlayers: maxPlayers,
        batchSize: batchSize,
        currentBatch: 0,
        totalBatches: Math.ceil(maxPlayers / batchSize),
        totalPlayersProcessed: 0,
        startTime: Date.now()
    };
    
    // Show progress
    const importBtn = document.getElementById('importStatsBtn');
    const progressContainer = document.getElementById('progressContainer');
    const progressDetails = document.getElementById('progressDetails');
    
    importBtn.disabled = true;
    progressContainer.style.display = 'block';
    progressDetails.style.display = 'block';
    
    try {
        if (weekSelection === 'totals') {
            await importSeasonTotals();
        } else if (weekSelection === 'all') {
            await importAllWeeks();
        } else {
            // Single week import
            const weekNumber = parseInt(weekSelection);
            await importSingleWeek(weekNumber);
        }
        
        showStatus('üéâ Import completed successfully!', 'success');
        
    } catch (error) {
        console.error('Import error:', error);
        showStatus(`‚ùå Import failed: ${error.message}`, 'error');
    } finally {
        importBtn.disabled = false;
        importState.isImporting = false;
    }
}

// Import a single week
async function importSingleWeek(weekNumber) {
    console.log(`Starting single week import for week ${weekNumber}`);
    updateCurrentOperation(`Importing Week ${weekNumber}...`);
    
    let start = 0;
    let totalImported = 0;
    
    while (start < importState.maxPlayers) {
        const currentBatchSize = Math.min(importState.batchSize, importState.maxPlayers - start);
        importState.currentBatch = Math.floor(start / importState.batchSize) + 1;
        
        updateProgressDisplay();
        
        console.log(`Fetching batch: start=${start}, batchSize=${currentBatchSize}, week=${weekNumber}`);
        
        try {
            const response = await fetch('/data/admin/stats', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    year: importState.year,
                    week: weekNumber, // Pass the ACTUAL week number
                    start: start,
                    batchSize: currentBatchSize,
                    max: importState.maxPlayers,
                    useStoredKeys: false
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP ${response.status}`);
            }
            
            const data = await response.json();
            console.log(`Batch response:`, data);
            
            totalImported += data.importedCount || 0;
            importState.totalPlayersProcessed += data.importedCount || 0;
            
            showStatus(`Week ${weekNumber}: Batch ${importState.currentBatch}/${importState.totalBatches} - ${data.importedCount} players`, 'info');
            
            // Check if we should continue
            if (!data.hasMore || data.importedCount === 0) {
                console.log('No more data or no imports, stopping');
                break;
            }
            
            start += currentBatchSize;
            
            // Small delay between batches
            await new Promise(resolve => setTimeout(resolve, 300));
            
        } catch (error) {
            console.error(`Error in batch starting at ${start}:`, error);
            throw error;
        }
    }
    
    console.log(`Week ${weekNumber} import complete: ${totalImported} players`);
    showStatus(`‚úÖ Week ${weekNumber} complete: ${totalImported} players imported`, 'success');
}

// Import season totals only
async function importSeasonTotals() {
    console.log('Starting season totals import');
    updateCurrentOperation('Importing Season Totals...');
    
    let start = 0;
    let totalImported = 0;
    
    while (start < importState.maxPlayers) {
        const currentBatchSize = Math.min(importState.batchSize, importState.maxPlayers - start);
        importState.currentBatch = Math.floor(start / importState.batchSize) + 1;
        
        updateProgressDisplay();
        
        try {
            const response = await fetch('/data/admin/stats', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    year: importState.year,
                    start: start,
                    batchSize: currentBatchSize,
                    max: importState.maxPlayers,
                    fetchTotals: true // No week parameter for totals
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || `HTTP ${response.status}`);
            }
            
            const data = await response.json();
            totalImported += data.totalsImported || 0;
            importState.totalPlayersProcessed += data.totalsImported || 0;
            
            showStatus(`Season Totals: Batch ${importState.currentBatch}/${importState.totalBatches} - ${data.totalsImported} players`, 'info');
            
            if (!data.hasMore || data.totalsImported === 0) {
                break;
            }
            
            start += currentBatchSize;
            await new Promise(resolve => setTimeout(resolve, 500));
            
        } catch (error) {
            console.error(`Error in totals batch starting at ${start}:`, error);
            throw error;
        }
    }
    
    showStatus(`‚úÖ Season totals complete: ${totalImported} players imported`, 'success');
}

// Import all weeks (simplified version)
async function importAllWeeks() {
    console.log('Starting all weeks import');
    
    // First import all weeks 1-18
    for (let week = 1; week <= 18; week++) {
        updateCurrentOperation(`Importing Week ${week} of 18...`);
        await importSingleWeek(week);
        
        // Reset batch counter for next week
        importState.currentBatch = 0;
    }
    
    // Then import season totals
    updateCurrentOperation('Importing Season Totals...');
    await importSeasonTotals();
}

// Update current operation display
function updateCurrentOperation(operation) {
    document.getElementById('currentOperation').textContent = operation;
}

// Update progress display
function updateProgressDisplay() {
    const progressPercent = Math.round((importState.currentBatch / importState.totalBatches) * 100);
    
    document.getElementById('progressBar').style.width = progressPercent + '%';
    document.getElementById('progressBar').textContent = progressPercent + '%';
    
    document.getElementById('batchProgress').textContent = 
        `${importState.currentBatch}/${importState.totalBatches}`;
        
    if (importState.weekSelection === 'all') {
        document.getElementById('weekProgress').textContent = 'All Weeks';
    } else if (importState.weekSelection === 'totals') {
        document.getElementById('weekProgress').textContent = 'Season Totals';
    } else {
        document.getElementById('weekProgress').textContent = `Week ${importState.weekSelection}`;
    }
    
    document.getElementById('totalPlayersCount').textContent = 
        importState.totalPlayersProcessed.toLocaleString();
}

// Show status message
function showStatus(message, type) {
    const statusDiv = document.getElementById('status');
    statusDiv.textContent = message;
    statusDiv.className = type;
    statusDiv.style.display = 'block';
    console.log(`Status: ${message} (${type})`);
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('confirmModal');
    if (event.target === modal) {
        closeModal();
    }
}

// Debug: Log when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, import functionality ready');
});

</script>

</body>
</html>
